## 2026-02-27 - US-004
- Created deepface_analytics/tracker.py with FaceTracker class
  - RECOGNITION_THRESHOLD=0.3, FACE_TRACKING_THRESHOLD=3.0, EMOTION_WINDOW_SIZE=30
  - _encoding_matrix: npt.NDArray[Any] of shape (N, embedding_dim); _face_ids: List[str] (parallel arrays)
  - is_same_as_known_face(encoding): vectorized np.linalg.norm(matrix - encoding, axis=1), returns face_id of closest if < threshold
  - add_face_encoding(face_id, encoding): reshapes to (1,-1) and np.vstack; handles empty matrix case separately
  - update_recent_emotion(emotion): appends to deque(maxlen=30), Counter.most_common(1)[0][0]
  - cleanup_trackers(tracked_faces): removes face_ids where now - state['last_seen'] > FACE_TRACKING_THRESHOLD
- Updated deepface_analytics/__init__.py to export FaceTracker
- Files changed: deepface_analytics/tracker.py (new), deepface_analytics/__init__.py (updated)
- **Learnings for future iterations:**
  - np.empty((0,0)) as initial matrix sentinel; check `len(self._face_ids) == 0` before vstack
  - Use `float(distances[min_idx]) < threshold` to coerce numpy scalar for mypy
  - `Counter[str]` from collections is subscriptable in Python 3.9+ and mypy strict accepts it
  - `Deque[str]` from typing works fine with mypy strict; `deque(maxlen=N)` for sliding window
  - cleanup_trackers takes `Dict[str, Any]` and modifies in-place; collect inactive keys first then delete
---

## Codebase Patterns
- ruff uses `[tool.ruff.lint]` section (not top-level `select`) in pyproject.toml
- deepface IS installed in this environment; `from deepface import DeepFace` works without `# type: ignore`
- For optional imports in try/except: if the package IS installed, mypy will flag `# type: ignore[name-defined]` as unused — omit it when package is available
- Legacy face_counter_emotions.py has `traceback.print_exc()` without traceback imported (F821 bug) - add `# noqa: F821` until fixed in US-007
- mypy per-file overrides: use `[[tool.mypy.overrides]]` with `module = "filename"` and `ignore_errors = true` for legacy files
- When ruff checks succeed, run `mypy <file>` separately to confirm typecheck
- face_counter_emotions.py is the monolithic legacy file - will be broken into deepface_analytics/ package in US-002 through US-006
- mypy strict mode: use `npt.NDArray[Any]` (from `numpy.typing`) for numpy arrays instead of bare `np.ndarray` to satisfy `type-arg` checks
- cv2.data.haarcascades does NOT need `# type: ignore` with mypy 1.19 + cv2 stubs
- Don't import `numpy as np` if only `numpy.typing as npt` is needed - avoids F401

# Ralph Progress Log
Started: Fri Feb 27 20:01:51 -03 2026
---

## 2026-02-27 - US-003
- Created deepface_analytics/analyzer.py with FaceAnalyzer class
  - EMOTION_RECHECK_INTERVAL = 2.0s constant
  - analyze_face(face_img, face_id): checks DEEPFACE_AVAILABLE, serves cache within TTL, downscales to 224x224 (INTER_AREA) if larger, calls DeepFace.analyze with actions=["emotion","age","embedding"], returns dict with dominant_emotion/emotion_scores/embedding/age keys
  - invalidate_cache(face_id): removes entry from internal _cache dict
  - Returns None when DEEPFACE_AVAILABLE is False
- Updated deepface_analytics/__init__.py to export FaceAnalyzer
- Files changed: deepface_analytics/analyzer.py (new), deepface_analytics/__init__.py (updated)
- **Learnings for future iterations:**
  - deepface IS installed; `# type: ignore[name-defined]` on _DeepFace.analyze() causes unused-ignore mypy error — omit it
  - cv2.resize dsize arg is (width, height), shape is (height, width) — for non-square targets must swap
  - _ANALYSIS_SIZE is (224,224) square so (h>224 or w>224) guard works for both axes
---

## 2026-02-27 - US-002
- Created deepface_analytics/__init__.py exporting FaceDetector
- Created deepface_analytics/detector.py with FaceDetector class
  - detect_faces(frame): gray conversion, equalization, detectMultiScale, filter_faces
  - filter_faces(faces): removes boxes smaller than MIN_FACE_SIZE
  - expand_bounding_box(x, y, w, h, frame_shape): expands by 10%, clamps to frame boundaries
  - Constants: MIN_FACE_SIZE=(30,30), SCALE_FACTOR=1.2, MIN_NEIGHBORS=6
- face_counter_emotions.py remains untouched (still runs)
- Files changed: deepface_analytics/__init__.py (new), deepface_analytics/detector.py (new)
- **Learnings for future iterations:**
  - Use `npt.NDArray[Any]` for numpy array type hints in strict mypy
  - cv2.data.haarcascades is accessible without type: ignore in mypy 1.19
  - Only import `numpy.typing as npt` if not using numpy directly to avoid F401
---

## 2026-02-27 - US-001
- Implemented quality infrastructure setup
- Files changed: requirements-dev.txt (new), pyproject.toml (new), face_counter_emotions.py (noqa comments)
- Created requirements-dev.txt with dev dependencies
- Created pyproject.toml with [tool.ruff.lint], [tool.mypy] (strict + ignore missing imports), [tool.pytest.ini_options]
- Added noqa comments for I001, F401, F821, E501 in legacy file
- Added mypy per-file override to ignore strict errors in legacy file
- **Learnings for future iterations:**
  - ruff's `select` must go under `[tool.ruff.lint]`, not top-level `[tool.ruff]`
  - The legacy file has ~50 mypy strict errors - excluded via per-file override, not fixing legacy code
  - `traceback.print_exc()` at line 431 is a real NameError bug (no import) - tagged `# noqa: F821` for now
  - mypy strict mode requires full type annotations which legacy code lacks
---
